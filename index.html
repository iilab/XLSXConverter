<style>
body {
    background-color: rgb(247, 235, 223);
    font-size: 15pt;
    font-family: "Times New Roman"; 
}
#drop{
    background-color: white;
    border:2px dashed #bbb;
    -moz-border-radius:5px;
    -webkit-border-radius:5px;
	border-radius:5px;
	padding:25px;
	text-align:center;
	font:20pt bold;
    color:#bbb
}
#out{
    clear: both;
    height: 500px;
    width: 100%;
}
#save {
    float: right;
    font-size: 15pt;
    margin-top: 15px;
    font-family: "Times New Roman"; 
}
#error {
    background-color: white;
    color: red;
}
#warnings p {
    background-color: orange;
}
</style>
<div id="drop">Drop an XLSX file here to convert to JSON.</div>
<button onclick="handleSave();" id="save">Save</button>
<p>Output:</p>
<div id="error"></div>
<div id="warnings"></div>
<textarea id="out"></textarea>

<br />

<script src="js-xlsx/jszip.js"></script>
<script src="js-xlsx/xlsx.js"></script>
<script src="js-xls/xls.js"></script>
<script src="underscore.js"></script>
<script src="XLSXConverter.js"></script>
<script>

function to_json(workbook) {
	var result = {};
	workbook.SheetNames.forEach(function(sheetName) {
		var rObjArr = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
		if(rObjArr.length > 0){
			result[sheetName] = rObjArr;
		}
	});
	return result;
}

function print_output(output) {
    var out = document.getElementById("out");
    if(out.innerText === undefined){
        out.textContent = output;
    } else {
        out.innerText = output;
    }
}

function handleSave(e) {
    var uriContent = "data:application/octet-stream," + encodeURIComponent(document.getElementById("out").value);
    var downloader = document.createElement("iframe");
    downloader.style.display = "none";
    downloader.src = uriContent;
    document.body.appendChild(downloader);
}

var drop = document.getElementById('drop');
//TODO: Test multiple forms
function handleDrop(e) {
	e.stopPropagation();
	e.preventDefault();
	var files = e.dataTransfer.files;
	var f = files[0];

	var reader = new FileReader();
	var name = f.name;
    
    //Clear the warnings and errors:
    var errorEl = document.getElementById('error');
    errorEl.innerText = "";
    var warnings = document.getElementById('warnings');
    while (warnings.hasChildNodes()) {
        warnings.removeChild(warnings.lastChild);
    }

    reader.onload = function(e) {
		var data = e.target.result;
        if(f.name.slice(-3) === "xls"){
            
            print_output("Sorry, XLS files are not supported.");
            /*
			var cfb = CFB.read(data, {type:'binary'})
			window.cfbs[name] = cfb;
			//cfb.Paths.forEach(function(x){console.log(x); out.innerText+=x+"\n";});
			var wb = parse_xlscfb(cfb);
			var ws = wb.Sheets[wb.Directory[0]] 
			var csv = make_csv(ws);  
			var cmds = get_formulae(ws).join("\n");
			out.innerText+=csv+"\n";
            */
        } else {
             try {
                var xlsx = XLSX.read(data, {type: 'binary'});
                var jsonWorkbook = to_json(xlsx);
                //console.log(jsonWorkbook);
                var processedWorkbook = XLSXConverter.processJSONWorkbook(jsonWorkbook);
                print_output(JSON.stringify(processedWorkbook, 2, 2));
                _.each(XLSXConverter.getWarnings(), function(warning){
                    var warningEl = document.createElement("p");
                    warningEl.innerText = warning;
                    console.log(warning);
                    warnings.appendChild(warningEl);
                });
            } catch(e) {
                errorEl.innerText = String(e);
                throw e;
            }
        }
	};
    try {
	    reader.readAsBinaryString(f);
    } catch(e) {
        errorEl.innerText = "Could not read file.";
        throw e;
    }
}

function handleDragover(e) {
	e.stopPropagation();
	e.preventDefault();
	e.dataTransfer.dropEffect = 'copy';
}
drop.addEventListener('dragover', handleDragover, false);
drop.addEventListener('drop', handleDrop, false);
</script>
